# GoDad åç«¯é¡¹ç›® Makefile

.PHONY: help run build test clean migrate migrate-status dev prod

# é»˜è®¤ç›®æ ‡
help:
	@echo "GoDad åç«¯é¡¹ç›®ç®¡ç†å·¥å…·"
	@echo ""
	@echo "å¯ç”¨å‘½ä»¤:"
	@echo "  help          æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯"
	@echo "  dev           å¼€å‘æ¨¡å¼å¯åŠ¨ï¼ˆè‡ªåŠ¨è¿ç§»ï¼‰"
	@echo "  prod          ç”Ÿäº§æ¨¡å¼å¯åŠ¨ï¼ˆä¸è‡ªåŠ¨è¿ç§»ï¼‰"
	@echo "  run           ç›´æ¥å¯åŠ¨æœåŠ¡"
	@echo "  build         ç¼–è¯‘é¡¹ç›®"
	@echo "  test          è¿è¡Œæµ‹è¯•"
	@echo "  clean         æ¸…ç†ç¼–è¯‘æ–‡ä»¶"
	@echo "  migrate       è¿è¡Œæ•°æ®åº“è¿ç§»"
	@echo "  migrate-status æŸ¥çœ‹æ•°æ®åº“è¿ç§»çŠ¶æ€"
	@echo ""
	@echo "ç¯å¢ƒå˜é‡:"
	@echo "  SERVER_ENV=development|production|testing"
	@echo "  DB_AUTO_MIGRATE=true|false"

# å¼€å‘æ¨¡å¼å¯åŠ¨
dev:
	@echo "ğŸš€ å¯åŠ¨å¼€å‘æ¨¡å¼..."
	@export SERVER_ENV=development && \
	export DB_AUTO_MIGRATE=true && \
	go run main.go

# ç”Ÿäº§æ¨¡å¼å¯åŠ¨
prod:
	@echo "ğŸš€ å¯åŠ¨ç”Ÿäº§æ¨¡å¼..."
	@export SERVER_ENV=production && \
	export DB_AUTO_MIGRATE=false && \
	go run main.go

# ç›´æ¥å¯åŠ¨æœåŠ¡
run:
	@echo "ğŸš€ å¯åŠ¨æœåŠ¡..."
	go run main.go

# ç¼–è¯‘é¡¹ç›®
build:
	@echo "ğŸ”¨ ç¼–è¯‘é¡¹ç›®..."
	go build -o bin/godad-backend main.go
	@echo "âœ… ç¼–è¯‘å®Œæˆï¼Œå¯æ‰§è¡Œæ–‡ä»¶: bin/godad-backend"

# è¿è¡Œæµ‹è¯•
test:
	@echo "ğŸ§ª è¿è¡Œæµ‹è¯•..."
	go test ./...

# æ¸…ç†ç¼–è¯‘æ–‡ä»¶
clean:
	@echo "ğŸ§¹ æ¸…ç†ç¼–è¯‘æ–‡ä»¶..."
	rm -rf bin/
	go clean

# è¿è¡Œæ•°æ®åº“è¿ç§»
migrate:
	@echo "ğŸ—„ï¸  æ‰§è¡Œæ•°æ®åº“è¿ç§»..."
	go run scripts/migrate.go --action=up

# å¼ºåˆ¶è¿è¡Œæ•°æ®åº“è¿ç§»ï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰
migrate-force:
	@echo "ğŸ—„ï¸  å¼ºåˆ¶æ‰§è¡Œæ•°æ®åº“è¿ç§»..."
	go run scripts/migrate.go --action=up --force

# æŸ¥çœ‹æ•°æ®åº“è¿ç§»çŠ¶æ€
migrate-status:
	@echo "ğŸ” æŸ¥çœ‹æ•°æ®åº“çŠ¶æ€..."
	go run scripts/migrate.go --action=status

# å®‰è£…ä¾èµ–
deps:
	@echo "ğŸ“¦ å®‰è£…ä¾èµ–..."
	go mod tidy
	go mod download

# ä»£ç æ ¼å¼åŒ–
fmt:
	@echo "âœ¨ æ ¼å¼åŒ–ä»£ç ..."
	go fmt ./...

# ä»£ç æ£€æŸ¥
vet:
	@echo "ğŸ” ä»£ç æ£€æŸ¥..."
	go vet ./...

# åˆ›å»º .env æ–‡ä»¶
init-env:
	@if [ ! -f .env ]; then \
		echo "ğŸ“„ åˆ›å»ºç¯å¢ƒé…ç½®æ–‡ä»¶..."; \
		cp .env.example .env; \
		echo "âœ… å·²åˆ›å»º .env æ–‡ä»¶ï¼Œè¯·ç¼–è¾‘é…ç½®ä¿¡æ¯"; \
	else \
		echo "âš ï¸  .env æ–‡ä»¶å·²å­˜åœ¨"; \
	fi

# å®Œæ•´çš„å¼€å‘ç¯å¢ƒè®¾ç½®
setup: init-env deps migrate-status
	@echo "ğŸ‰ å¼€å‘ç¯å¢ƒè®¾ç½®å®Œæˆ!"
	@echo "ä½¿ç”¨ 'make dev' å¯åŠ¨å¼€å‘æœåŠ¡å™¨"